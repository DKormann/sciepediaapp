var ge=Object.defineProperty;var be=(e,t,n)=>t in e?ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var $=(e,t,n)=>(be(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerpolicy&&(i.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?i.credentials="include":r.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const oe=(e,t)=>E(e)==E(t),Z=(e,t)=>f(e,!0,t),f=(e,t,n)=>{if(!oe(e,t))throw new Error(`
  `+E(e)+`
!=`+E(t)+(n?`
`+n:""))},ie=(...e)=>(console.log(...e.map(t=>t instanceof HTMLElement||t instanceof Event||t instanceof Node||typeof t=="string"?t:E(t))),_(e)),E=e=>e==null?"undefined":typeof e=="bigint"?e.toString()+"n":typeof e=="function"?e.toString():e instanceof Array?`[${e.length==0?"":e.map(t=>E(t)).join(", ").replace(/\n/g,`
  `)}]`:e instanceof HTMLElement||e instanceof Node?`<${e.nodeName} : "${e.textContent}">`:typeof e=="object"?`{
  ${Object.entries(e).sort().filter(([t,n])=>t!="id").map(([t,n])=>`${t}:${E(n)}`).join(`,
`).replace(/\n/g,`
  `)}
}`:JSON.stringify(e),_=e=>e[e.length-1];function D(e,t=BigInt(890914615527653)){let n=t;const o=BigInt(1099511628211);for(let r=0;r<e.length;r++)n^=BigInt(e.charCodeAt(r)),n*=o;return n&(BigInt(1)<<BigInt(64))-BigInt(1)}const U=e=>{const t=n=>{if(n==null)return[n,D("undefined")];if(n.id!=null)return[n,n.id];if(n instanceof Array){const o=n.map(i=>t(i)),r=D(o.map(([i,s])=>s).join(","));return[o.map(([i,s])=>i),r]}if(n instanceof Object){const o=Object.entries(n).map(([s,c])=>[s,t(c)]),r=D(o.map(([s,[c,d]])=>`${s}:${d}`).join(","));return[Object.fromEntries(o.map(([s,[c,d]])=>[s,c]).concat([["id",r]])),r]}return[n,D(E(n))]};return t(e)[0]},ve=(e,...t)=>t.reduce((n,o)=>o(n)||n,e),se=(e,t)=>e.children.find(n=>n.path[n.path.length-1]===t)||{Content:"",path:[...e.path,t],children:[]},P=(e,t)=>t.length===0?e:se(P(e,t.slice(0,-1)),t[t.length-1]),G=(...e)=>e.reduce(M,{path:[],children:[]}),v=(e,t,...n)=>({path:e.split("."),Content:t,children:n}),we=e=>e[e.length-1],ce=(e,t,n)=>({...e,children:e.children.filter(o=>we(o.path)!==t).concat([n])}),M=(e,t)=>{if(e.path.length===t.path.length)return t;const n=t.path[e.path.length];return ce(e,n,M(se(e,n),t))},le=(e,t)=>{if(t.length===0)throw new Error("getData root");return P(e,t)},_e=(e,t)=>M(e,t),Le=(e,t)=>{e||console.error(t)};ve(G(v("a","a",v("a.b","b",v("a.b.c","c")))),e=>f(P(e,["a","b","c"]),v("a.b.c","c"),"getNode"),e=>ce(e,"ap",v("ap","ap")),e=>M(e,v("a.b.c.d","d")),e=>M(e,v("a.b.c.d","f")),e=>f(P(e,["a","b","c","d"]),v("a.b.c.d","f"),"setNode"),e=>M(e,v("f.f.f.f","f")),e=>f(P(e,["f","f"]).children.length,1,"setNode"),e=>f(P(e,[]),e,"getNode root"),e=>Le(P(e,["a","b"]).Content==="b","get Content"));const x=(e,t,n,o)=>{const r=document.createElement(e);return r.innerText=t,n&&r.classList.add(...n.split(".").filter(i=>i)),o&&Object.entries(o).forEach(([i,s])=>{i==="children"?s.forEach(c=>r.appendChild(c)):i==="eventListeners"?Object.entries(s).forEach(([c,d])=>{r.addEventListener(c,d)}):i==="color"||i==="background"?r.style[i]=s:r[i]=s}),r},Ee=["(",")","{","}","[","]","=>",",",":","?","=>","!","&&","||","+","-","*","/","%","<",">","<=",">=","==","!=","=",";","...",".","//"],K=(e,t,n)=>{const o=e.slice(t).split("").findIndex(n);return o==-1?e.length:t+o},b=(e,t=0,n=0)=>{if(e.length<=t)return[];const o=s=>e.slice(t,t+s.length)==s,[r,i]=e[t].trim()==""?["whitespace",K(e,t,s=>s.trim()!="")]:e[t]=='"'?["string",K(e,t+1,s=>s=='"')+1]:e[t]=="'"?["string",K(e,t+1,s=>s=="'")+1]:e[t].match(/[0-9]/)?["number",K(e,t,s=>!s.match(/[0-9]/))]:o("//")?["comment",K(e,t,s=>s==`
`)]:o("true")?["boolean",t+4]:o("false")?["boolean",t+5]:o("null")?["null",t+4]:e[t].match(/[a-zA-Z_]/)?["identifier",K(e,t,s=>!s.match(/[a-zA-Z0-9_]/))]:Ee.map(s=>o(s)?["symbol",t+s.length]:null).find(s=>s!=null)||["typo",t+1];return f(i>t,!0,"tokenize error "+r),[{type:r,value:e.slice(t,i),start:t,end:i},...b(e,i,n+1)]},X=["?:","=;"],$e=[["(",")"],["{","}"],["[","]"],["?",":"],["=",";"]],B=["+","-","*","/","%","<",">","<=",">=","==","!=","&&","||","app","=>","index"],ae=["!","neg","..."],xe=(e,t,n,o=[])=>(B.includes(e)&&f(o.length,2,"newast error "+e),X.includes(e)&&f(o.length,3,"newast error "+e),{type:e,start:t,end:n,children:o}),I=e=>{const t=a=>e[a]==null?-1:e[a].type=="whitespace"||e[a].type=="comment"?t(a+1):a,n=a=>t(e.findIndex(l=>l.start>=a.end)),o=a=>a.type=="identifier"?{...a,type:"string",value:`"${a.value}"`}:a,r=a=>{const l=y(a);if(l.type=="typo")return l;const m=e[n(l)];if(m==null)return{...l,type:"typo",value:"expected : or } after {",children:[]};if(l.type=="...")return l;const u=m.value==":"?y(n(m)):l;return{type:":",value:"",start:l.start,end:u.end,children:[l.type=="identifier"?o(l):l,u]}},i=(a,l)=>{var te;const m=(te=$e.find(me=>me[0]==a.value))==null?void 0:te[1];if(m==null)throw new Error("parsegroup error "+a.value+" not an opener");const u="?=".includes(a.value)?"()":a.value+m,g=e[l];if(g==null)return{type:"typo",value:`end of input. expected ${m} because of ${a.value}`,start:a.start,end:_(e).end,children:[]};if(g.value==m)return{type:u,value:"",children:[],start:a.start,end:g.end};if(g.value==",")return i(a,n(g));if("])};:".includes(g.value))return{type:"typo",value:`cant parse ${u}. expected ${m} because of ${a.value}`,start:g.start,end:g.end,children:[]};const w=u=="{}"?r(l):y(l);if(w.type=="typo")return w;const C=i(a,n(w));return C.type=="typo"?C:xe(u,a.start,C.end,[w,...C.children])},s=(a,l)=>({type:a,children:l,start:l[0].start,end:_(l).end,value:""}),c=a=>{const l=e[n(a)];if(l==null)return a;if(l.type=="symbol"){if("[(".includes(l.value)){const u=i(l,n(l)),g=l.value=="("?"app":"index";if(l.value=="["&&u.children.length!=1)return c({...u,type:"typo",value:g+" expects one arg",children:[]});const w={...u,type:g,value:"",start:a.start,end:u.end,children:[a,l.value=="["?u.children[0]:u]};return c(w)}const m=l.value=="."?"index":l.value=="?"?"?:":l.value=="="?"=;":l.value;if(B.includes(m)){const u=p(n(l)),g=s(m,[a,l.value=="."?o(u):u]);return c(g)}if(X.includes(m)){const u=i(l,n(l)),g=y(n(u));return c(s(m,[a,u.children[0]||u,g]))}}return a},d=a=>["number","string","boolean","null","identifier"].includes(e[a].type)?{...e[a],children:[]}:void 0,p=a=>{var w,C;const l=e[a],m={...l,type:"typo",value:"unexpected "+((w=l==null?void 0:l.value)!=null?w:"end of input"),children:[]};if(l==null)return m;const u=l.value=="-"?"neg":l.value;return l.type=="symbol"?"({[".includes(u)?i(l,t(a+1)):ae.includes(u)?s(u,[p(n(l))]):m:(C=d(a))!=null?C:m},y=a=>c(p(a)),h=y(t(0));return Z(!h.children.includes(void 0)),n(h)!=-1?{...h,start:0,end:_(e).end,type:"typo",value:"expected end "+e[n(h)].value,children:[]}:h},N=e=>{const t=Y(e);if(t.length>0)throw new Error(t.map(o=>o.value).join(`
`));const n=(o,r=0)=>r==e.children.length?o:n(o.replace("{}",N(e.children[r])),r+1);return e.type=="number"||e.type=="boolean"||e.type=="null"||e.type=="identifier"||e.type=="string"?e.value:"({[".includes(e.type[0])?`${e.type[0]}${e.children.map(N).join(",")}${e.type[1]}`:e.type=="app"?n("({}{})"):e.type=="index"?n("({}[{}])"):e.type=="neg"?`-${N(e.children[0])}`:e.type=="=>"?n("({}=>({}))"):e.type==":"?n("{}:{}"):e.children.length==2?n(`({}${e.type}{})`,0):e.children.length==1?`${e.type}${N(e.children[0])}`:e.type=="=;"?n(`(()=>{const {} = {};
return {}})()`):e.type=="?:"?n(`({}?{}:
{})`,0):e.type=="typo"?(()=>{throw new Error(`${e.value}`)})():(()=>{throw new Error("not implemented: "+e.type)})()},W=e=>e==="app"||e==="index"?15:ae.includes(e)?13:e==="*"||e==="/"||e==="%"?12:e==="+"||e==="-"?11:e==="<"||e===">"||e==="<="||e===">="||e==="=="||e==="!="?10:e==="&&"||e==="||"?9:e==="?:"||e==="=;"?8:e==="=>"?7:-1,T=e=>{Z(e!=null,"rearange error"),e.children.includes(void 0)&&ie(e.children);const t={...e,children:e.children.map(T)};if(B.includes(t.type)){const[n,o]=t.children;if(B.includes(n.type)&&W(n.type)<W(t.type))return T({...n,children:[n.children[0],{...t,children:[n.children[1],o]}]})}if(X.includes(t.type)){f(t.children.length,3,"rearange error"+E(t));const[n,o,r]=t.children;if(B.includes(n.type)&&W(n.type)<W(t.type))return T({...n,children:[n.children[0],{...t,children:[n.children[1],o,r]}]})}return t},Ne=e=>N(T(I(b(e)))),de=e=>T(I(e)),ue=e=>{const t=N(e);try{const n=Function("htmlElement","return "+t),o=22;return n(x)}catch(n){return n.message}},Ae=e=>ue(de(b(e))),Ie=(e,t)=>Array.from({length:t-e},(n,o)=>o+e),Y=e=>e.type=="typo"?[e]:e.children.map(Y).flat(),je=(e,t)=>{const n=new Set(Y(t).map(i=>Ie(i.start,i.end)).flat()),o=e.map(i=>i.value.split(`
`).map(s=>[{code:s,cls:(n.has(i.start)||n.has(i.end)?".err.":".")+(i.type=="typo"?"red":i.type=="identifier"||i.type=="number"||i.value=="."?"code1":i.type=="string"||i.type=="boolean"||i.type=="comment"?"code2":"?:=;".includes(i.value)?"code3":i.type=="symbol"?"code4":"")}]));return o.slice(1).reduce((i,s)=>[...i.slice(0,-1),[..._(i),...s[0]],...s.slice(1)],o[0]).map(i=>i.map(s=>s.code.split("").map(c=>({cls:s.cls}))).flat())};{f(b("1"),[{type:"number",value:"1",start:0,end:1}]),f(b("1 +  1"),[{type:"number",value:"1",start:0,end:1},{type:"whitespace",value:" ",start:1,end:2},{type:"symbol",value:"+",start:2,end:3},{type:"whitespace",value:"  ",start:3,end:5},{type:"number",value:"1",start:5,end:6}]),f(b('{"gello" + ]22',0),[{type:"symbol",value:"{",start:0,end:1},{type:"string",value:'"gello"',start:1,end:8},{type:"whitespace",value:" ",start:8,end:9},{type:"symbol",value:"+",start:9,end:10},{type:"whitespace",value:" ",start:10,end:11},{type:"symbol",value:"]",start:11,end:12},{type:"number",value:"22",start:12,end:14}]),f(b("true"),[{type:"boolean",value:"true",start:0,end:4}]),f(b(`a + // comment
b`),[{type:"identifier",value:"a",start:0,end:1},{type:"whitespace",value:" ",start:1,end:2},{type:"symbol",value:"+",start:2,end:3},{type:"whitespace",value:" ",start:3,end:4},{type:"comment",value:"// comment",start:4,end:14},{type:"whitespace",value:`
`,start:14,end:15},{type:"identifier",value:"b",start:15,end:16}]);const e=(...o)=>{var r;try{const i=N(I(b(o[0])));f(i,(r=o[1])!=null?r:o[0]," compiling "+o[0])}catch(i){console.error(i," in compiling "+o[0])}};f(I(b("1")),{type:"number",value:"1",start:0,end:1,children:[]}),f(I(b("2312")),{type:"number",value:"2312",start:0,end:4,children:[]}),f(I(b("true")),{type:"boolean",value:"true",start:0,end:4,children:[]}),f(N(I(b("1"))),"1"),f(N(I(b("[1]"))),"[1]"),e("1"),e("[1]"),e("true"),e("false"),e("null"),e("123"),e("{}"),e("{a,}",'{"a":a}'),e("-x"),e("x + y","(x+y)"),e("[a+1]","[(a+1)]"),e("[a+1,b-1]","[(a+1),(b-1)]"),e("{a:1}",'{"a":1}'),e("...a","...a"),e("{a:1, b:2,...c}",'{"a":1,"b":2,...c}');const t=(o,r)=>{try{f(Ne(o),r," in compiling "+o)}catch(i){console.error(i," in compiling "+o)}};t("1","1"),t("a + 3","(a+3)"),t("!a+b","(!a+b)"),t("a + b + c","((a+b)+c)"),t("a + b * c","(a+(b*c))"),t("[a + b * c]","[(a+(b*c))]"),t("a + b * c . d",'(a+(b*(c["d"])))'),t("a * b + c","((a*b)+c)"),t("!a * b +c","((!a*b)+c)"),t("a ? b : c",`(a?b:
c)`),t("a>b?c:d",`((a>b)?c:
d)`),t("a=b;c",`(()=>{const a = b;
return c})()`),t("14 ","14"),t("1 + 2","(1+2)"),t("1 * 2 + 3","((1*2)+3)"),t("{a:1, b:2}",'{"a":1,"b":2}'),t("{a, ...b}",'{"a":a,...b}'),t("x.y",'(x["y"])'),t("x[y]","(x[y])"),t("x=>y","(x=>(y))"),t("x=>x.y",'(x=>((x["y"])))'),t("1 > 2 ? 3 : 4",`((1>2)?3:
4)`),t("1>2?3:4",`((1>2)?3:
4)`),t("fn(22)","(fn(22))"),t("fn(22) + 3","((fn(22))+3)"),t('"a"+"b"','("a"+"b")'),t("a.b",'(a["b"])'),t("n=>n<2?n:2",`(n=>(((n<2)?n:
2)))`),t("fn(x-2)","(fn((x-2)))"),t("a+b(c)","(a+(b(c)))"),t("[fn(x),2]","[(fn(x)),2]"),t("[x[3],e.r,2,]",'[(x[3]),(e["r"]),2]'),t("[-x, !true]","[-x,!true]"),t("a.b",'(a["b"])'),t("a.b.c",'((a["b"])["c"])'),t("a.b(22)",'((a["b"])(22))'),t("a(b).c",'((a(b))["c"])'),t("a.b(f(22))",'((a["b"])((f(22))))'),t('"hello " + "world"','("hello "+"world")'),t("f(a, b)","(f(a,b))");const n=(o,r)=>f(Ae(o),r," in running "+o);n(`
1`,1),n("1 + 2",3),n('"hello" + "world"',"helloworld"),n("x=1;x",1),n('x="hello";x+x',"hellohello"),n("[a,b] = [1,2]; a",1)}class F{constructor(t,n){$(this,"_is_main");$(this,"_side_store");$(this,"get",t=>{var o;const n=this._is_main?localStorage.getItem("sciepedia"+t)||"null":((o=this._side_store)==null?void 0:o.get(t))||"null";if(!this._is_main&&!this._side_store)throw new Error("side store not initialized");return JSON.parse(n)});$(this,"set",(t,n)=>{const o=JSON.stringify(n,(r,i)=>r=="id"?void 0:i);if(this._is_main)return localStorage.setItem("sciepedia"+t,o),this._is_main=!1,this._side_store=new Map,new F(!0,null);if(this._side_store){console.error("WARNING: side store initialized");const r=new Map(this._side_store);return new F(!1,r.set(t,o))}else throw new Error("side store not initialized")});this._is_main=t,this._side_store=n}}class Q{constructor(){$(this,"_store");$(this,"get",t=>this._store.get(t)||null);$(this,"set",(t,n)=>{const o=new Map(this._store);return new Q().setStore(new Map(o.set(t,n)))});$(this,"setStore",t=>(this._store=t,this));this._store=new Map}}const ne=new F(!0,null),Ce=new Q,k=(e,t)=>n=>({...n,store:e=="r"?n.store.set("root",t):n.store,[e]:U(t)}),ee=e=>e.startsWith("#")&&e.length>1;function pe(e){const t=b(e),n=de(t);return[je(t,n),n]}const J=(e,t,n)=>{const o=le(e,t),r=o.path.join("."),i=_(t)=="fs"?pe(o.Content)[0]:void 0;return[{content:r,path:t,indent:n,is_title:!0,children:[]},...o.Content.split(`
`).map((s,c)=>({content:s,indent:n,path:t,children:[],cursor:-1,colormap:i?i[c]:void 0})),..._(t)=="fs"?J(e,t.concat(">>>"),n+1):[]]},j=(e,t)=>{var o;const n=e.selection?[e.selection.start,e.selection.end].sort((r,i)=>r-i):void 0;return{...e,el:x("p","","line",{children:[...Array.from({length:e.indent},r=>x("div","","pad")),...e.is_title?[x("span",e.content,"title")]:Pe(t!=null?e.content.split("").map((r,i)=>x("span",r,"char"+t[i].cls)):e.content.split(" ").map(r=>(" "+r).split("").map(i=>({c:i,w:r}))).flat().slice(1).map(({c:r,w:i},s)=>{var c,d;return x("span",r,(e.colormap?(d=(c=e.colormap[s])==null?void 0:c.cls)!=null?d:"":ee(i)?"link":"char")+(n&&s>=n[0]&&s<n[1]?".selected":""))}),(o=e.selection)==null?void 0:o.end,Se())],...t?{color:t}:{}})}},Pe=(e,t,...n)=>t!=null&&t>=0?[...e.slice(0,t),...n,...e.slice(t)]:e,fe=(e,t,n)=>o=>{const r=ye(o),i=r.p[e],s=i.content.slice(t,n);f(ee(s),!0,"open non link:"+s);const c=r.p.slice(e+1),d=c.findIndex(p=>p.indent==i.indent);return d<=0?z([e,e+1],{...i,content:i.content.slice(0,n),el:void 0},...J(r.r,s.slice(1).split("."),i.indent+1).map(p=>j(p)),{...i,content:i.content.slice(n),el:void 0})(r):z([e,e+d+2],j({...i,content:i.content+c[d].content,el:void 0}))(r)},Se=()=>x("div","","cursor"),ke=e=>t=>(typeof e=="number"?[t.p[e]]:t.p.slice(...e[0]>e[1]?[e[1],e[0]]:e)).map(n=>n),O=(e,t)=>n=>z(e,...t(ke(e)(n)))(n),z=(e,...t)=>n=>{const[o,r]=(typeof e=="number"?[e,e+1]:e).sort((s,c)=>s-c);Z(r>=o,`end>=start ${r}>=${o}`);const i=(t.length?t[0]:n.p[o]).path;return t.filter(s=>s.selection),L(k("p",[...n.p.slice(0,o),...t.map(s=>j(s)),...n.p.slice(r)]),s=>k("r",_e(s.r,v(i.join("."),V(o,s).slice(1).map(c=>c.content).join(`
`))))(s))(n)},Ke=(e,t)=>{const n=V(t,e),o=ze(t,e),r=o.split(`
`),[i,s]=pe(o);try{const c=A(t,e),d=S(t,e),p=A(d,e),y=k("p",[...e.p.slice(0,c+1),...i.map((a,l)=>j({...n[l+1],content:r[l],is_title:void 0},a)),...e.p.slice(p)])(e),h=a=>z([A(d,y)+1,d+1],...a.map(l=>j({...y.p[d],content:l,is_title:void 0})));try{const a=E(ue(s)).split(`
`);return h(a)(y)}catch(a){return console.warn(a),h(a.message.split(`
`))(y)}}catch(c){console.error(c);return}},L=(...e)=>t=>e.reduce((n,o)=>{var r;return(r=o(n))!=null?r:n},t),he=e=>k("p",e.p.map(t=>j({...t,selection:void 0,el:void 0})))(e),re=(e,t,n)=>Math.min(Math.max(e,t),n),Me=(e,t)=>L(he,O(e,([n])=>n==null?[]:[{...n,selection:{start:t,end:t},el:void 0}])),q=([[e,t],[n,o]])=>{const r=e>n||e==n&&t>o;return L(he,r?O([n,e+1],i=>i.map((s,c)=>({...s,selection:{start:c==i.length-1?t:s.content.length,end:c==0?o:0}}))):O([e,n+1],i=>i.map((s,c)=>({...s,selection:{start:c==0?t:0,end:c==i.length-1?o:s.content.length}}))))},R=e=>{const t=e.p.findIndex(o=>o.selection);if(t==-1)return[void 0,void 0];const n=e.p.slice(t).findIndex(o=>!o.selection);return[t,n==-1?e.p.length:n+t]};function Oe(e,t){return e.findIndex(({el:n})=>n.clientHeight+n.offsetTop>t)}const Be=e=>Array.from(e.el.children).filter(t=>t.nodeName=="SPAN"),Te=(e,t)=>{const n=Be(e),o=n.findIndex(r=>r.offsetLeft+r.offsetWidth/2>t);return o==-1?n.length:o},S=(e,t)=>{const n=t.p.slice(e).findIndex(o=>o.indent<t.p[e].indent);return n>-1?n+e-1:t.p.length-1},A=(e,t)=>e-t.p.slice(0,e).reverse().findIndex(n=>n.is_title&&n.indent==t.p[e].indent)-1,V=(e,t)=>t.p.slice(A(e,t),S(e,t)+1).filter(n=>n.indent==t.p[e].indent),ze=(e,t)=>V(e,t).slice(1).map(n=>n.content).join(`
`),De=(e,t)=>[t-_(e.content.slice(0,t).split(" ")).length,t+e.content.slice(t).split(" ")[0].length],ye=e=>_(e.hist)==null||U(e).id!=U(_(e.hist)).id?k("hist",[...e.hist.slice(-10),e])(e):(ie("no change"),e);{const e=G(v("hello","hello #world #link"),v("link",`link content
second line
3rd line`)),t=J(e,["hello"],1).map(r=>j(r)),n={r:e,p:t,cursor:0,store:Ce,hist:[]},o=r=>r.map((i,s)=>"->".repeat(i.indent)+i.content).join(`
`);L(fe(1,13,19),r=>f(o(r.p),`->hello
->hello #world #link
->->link
->->link content
->->second line
->->3rd line
->`,"toggle link"),r=>f(S(0,r),6,"lastPageLine"),r=>f(S(2,r),5,"lastPageLine"),r=>f(S(5,r),5,"lastPageLine"),r=>f(S(6,r),6,"lastPageLine"),r=>f(A(0,r),0,"firstPageLine"),r=>f(A(6,r),0,"firstPageLine"),r=>f(A(5,r),2,"firstPageLine"),r=>f(A(1,r),0,"firstPageLine"),r=>z([4,5],{...r.p[4],content:"second #line"})(r),r=>f(o(V(4,r)),`->->link
->->link content
->->second #line
->->3rd line`,"seekPage"),r=>f(le(r.r,["link"]).Content,`link content
second #line
3rd line`,"set link"))(n)}const We=e=>{var r;const t=(i,s)=>{const c=Oe(s.p,i.y+window.scrollY);if(c===-1)return[void 0,void 0];const d=Te(s.p[c],i.x+window.scrollX);return[c,d]},n=i=>L(s=>{const[c,d]=R(s);if(!(c==null||_(s.p[c].path)!="fs"))return Ke(s,c)},s=>{e(x("div","","root",{children:s.p.map(c=>c.el),eventListeners:{mousedown:c=>{const[d,p]=t(c,s);c.shiftKey||L(k("mousestart",d?{p:d,c:p}:void 0),y=>d?q([[d,p],[d,p]])(y):y,n)(s)},mouseup:c=>L(d=>{const[p,y]=t(c,d);if(p!=null){if(c.shiftKey){const[h,a]=R(d);return h==null?void 0:q([[h,d.p[h].selection.start],[p,y]])(d)}if(!!d.mousestart&&oe(d.mousestart,{p,c:y})){const[h,a]=De(d.p[p],y);if(ee(d.p[p].content.slice(h,a)))return fe(p,h,a)(d)}}},k("mousestart",void 0),n)(s),mousemove:c=>{if(!s.mousestart)return;const[d,p]=t(c,s);d!=null&&n(q([[s.mousestart.p,s.mousestart.c],[d,p]])(s))},keydown:c=>{if(["Meta","Alt","Control","Shift"].includes(c.key)||(c.key.startsWith("Arrow")&&c.preventDefault(),c.key=="Escape"))return;const d=R(s);if(d[0]!=null)return L(p=>{if(["Tab","Enter","Backspace"].includes(c.key)||c.key.length==1)return c.metaKey?void 0:L(O(d,y=>{const h=y[0],a=_(y),l=a.content.slice(Math.max(a.selection.start,a.selection.end)),m=(h.content.slice(0,Math.min(h.selection.start,h.selection.end))+(c.key.length==1?c.key:c.key=="Tab"?"  ":c.key=="Enter"?`
`:"")).split(`
`);return m.map((u,g)=>g==m.length-1?{...h,content:u+l,selection:{start:u.length,end:u.length}}:{...h,content:u,selection:void 0})}),ye)(p)},p=>{const y=R(p);if(y[0]==null)return;const h=y[0],a=p.p[h],l=a.selection.start;if(c.key.startsWith("Arrow")){const[m,u]=c.key=="ArrowUp"?[c.altKey?h-5:c.metaKey?A(h,p)+1:h-1,l]:c.key=="ArrowDown"?[c.altKey?h+5:c.metaKey?S(h,p):h+1,l]:c.key=="ArrowLeft"?[h,Math.max(0,c.altKey?l-5:c.metaKey?0:l-1)]:c.key=="ArrowRight"?[h,c.altKey?l+5:c.metaKey?a.content.length:l+1]:[h,l],[g,w]=[re(m,0,p.p.length-1),re(u,0,a.content.length)];return p.p[g].is_title?void 0:Me(g,w)(p)}if(c.key=="Escape"&&c.preventDefault(),c.key=="Backspace"){const m=Math.max(0,l-(c.altKey?5:c.metaKey?100:1));if(l==0){const u=p.p[y[0]-1];return u==null||u.is_title?void 0:O([y[0]-1,y[0]+1],([g,w])=>[{...g,content:g.content+w.content,selection:{start:g.content.length,end:g.content.length}}])(p)}return O(y,([u])=>[{...u,content:u.content.slice(0,m)+u.content.slice(l),selection:{start:m,end:m}}])(p)}},n)(s)}}}))})(i),o=(r=ne.get("root"))!=null?r:G(v("hello","hello world"),v("script.fs",`
fib = (n) =>
  n<2 ? n :
  fib(n-1) + fib(n-2);

fastfib = (n) =>
  _fib = n =>
    n == 0 ? [1,0]:
    [a,b] = _fib(n-1);
    [b,a+b];
  _fib(n)[0];


[fib(7), fastfib(70)]
`),v("script.fs.>>>","RESULT"));L(n)({r:o,p:J(o,["hello"],1).map(i=>j(i)),store:ne,hist:[]})},H=document.createElement("div");H.setAttribute("id","viewer");document.body.appendChild(H);We(e=>{var t;H.childNodes.forEach(n=>n.remove()),H.appendChild(e),e.tabIndex=(t=e.tabIndex)!=null?t:0,e.focus()});
